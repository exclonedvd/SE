<!DOCTYPE html>
<html lang="it">
<head>
<link rel="preload" as="image" href="img/logo-antares.webp">
<link rel="preload" as="image" href="img/hero.webp">
<style>
.site-logo img{ border-radius:50%; width:64px; height:64px; object-fit:cover; display:block }
@media (min-width:768px){ .site-logo img{ width:72px; height:72px } }

.select-wrap{ position:relative; width:100% }
.select.fancy{
  -webkit-appearance:none; appearance:none;
  width:100%;
  padding:12px 44px 12px 14px;
  border-radius:14px;
  border:1px solid #ffffff1f;
  color:var(--txt);
  background:
    linear-gradient(180deg, #ffffff14, #ffffff08),
    var(--glass-strong);
  box-shadow:0 10px 30px #00000033;
  font:inherit; cursor:pointer;
  transition: transform .12s ease, box-shadow .12s ease, background .2s, border-color .2s;
}
.select.fancy:hover{
  transform: translateY(-1px);
  box-shadow:0 14px 34px #00000044;
  border-color:#9acbff44;
  background:
    linear-gradient(180deg, #75e6ff40, #7c6bff30),
    var(--glass-strong);
}
.select.fancy:focus{ outline:2px solid #7daaffaa; outline-offset:2px }
.select-wrap::after{
  content:"";
  position:absolute; right:12px; top:50%; transform:translateY(-50%);
  width:22px; height:22px; pointer-events:none; opacity:.9;
  background:
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23dfe8ff' d='M7 10l5 5 5-5z'/></svg>")
    center/20px 20px no-repeat;
  filter: drop-shadow(0 1px 0 rgba(0,0,0,.25));
}
@media (prefers-color-scheme: light){
  .select-wrap::after{ background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%231a2440' d='M7 10l5 5 5-5z'/></svg>"); }
}

.modal-overlay{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.45); z-index:9999; backdrop-filter: blur(4px); }
.modal-overlay.hidden{ display:none }
.modal{ max-width:420px; width:92vw; border-radius:18px; padding:18px; background:var(--glass); border:1px solid #ffffff2a; box-shadow:0 20px 50px #00000055 }
.modal-header{ font-weight:800; font-size:1.15rem; margin-bottom:10px }
.modal-body{ color:var(--muted); margin-bottom:16px }
.modal-actions{ display:flex; gap:10px; justify-content:flex-end }

/* dropdown dark fix */
.select.fancy{ color-scheme: dark; }
.select.fancy option, .select.fancy optgroup{
  background-color: rgba(16, 26, 44, .98);
  color: var(--txt);
}
@media (prefers-color-scheme: light){
  .select.fancy{ color-scheme: light; }
  .select.fancy option, .select.fancy optgroup{
    background-color:#fff;
    color:#1a2440;
  }
}
</style>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>27¬∞ Corso Sergenti Antares II ‚Äì Riassunti & Quiz</title>
  <meta name="description" content="Portale per riassunti PDF e simulatore di quiz per materia." />
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg1:#0f1226; --bg2:#0b1b32; --ac1:#6ee7f2; --ac2:#a78bfa; --ac3:#22d3ee; --ok:#22c55e; --ko:#ef4444;
           --glass: rgba(255,255,255,.08); --glass-strong: rgba(255,255,255,.14); --txt:#eaf2ff; --muted:#a9b4d6; }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial;
          color:var(--txt); background: radial-gradient(1200px 800px at 10% -10%, #1c2b6b40 0%, transparent 60%),
                             radial-gradient(1000px 600px at 110% 0%, #00eaff22 0%, transparent 60%),
                             linear-gradient(120deg, var(--bg1), var(--bg2)); overflow-x:hidden; }
    .aurora{ position:fixed; inset:-50% -20% -20% -20%; pointer-events:none; filter:blur(60px); opacity:.4; mix-blend-mode:screen;
             background: conic-gradient(from 180deg at 50% 50%, #6ee7f2 0deg, #a78bfa 120deg, #22d3ee 240deg, #6ee7f2 360deg);
             animation: spin 30s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    header{ position:sticky; top:0; z-index:50; backdrop-filter:saturate(130%) blur(10px);
            background:linear-gradient(180deg, rgba(10,14,32,.9), rgba(10,14,32,.4));
            border-bottom:1px solid #ffffff14; padding:.8rem 1rem; display:flex; align-items:center; gap:.8rem; }
    .logo{ width:44px; height:44px; border-radius:50%; background:none; 
           display:grid; place-items:center; overflow:hidden; }
.logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .title{ font-size:1.1rem; font-weight:800; letter-spacing:.2px } .spacer{flex:1} .pill{font-size:.85rem; color:var(--muted)}
    main{ max-width:1100px; margin:0 auto; padding:24px 16px 80px; }
    .hero{ margin-top:18px; display:grid; grid-template-columns:1fr; gap:18px; align-items:stretch; }
    .card{ background:var(--glass); border:1px solid #ffffff1a; border-radius:20px; padding:18px; box-shadow:0 10px 30px #00000033; }
    .card h2{ margin:6px 0 10px; font-size:1.15rem }
    .btn-row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:10px }
    .btn{ display:inline-flex; align-items:center; gap:10px; padding:14px 16px; border-radius:14px; border:1px solid #ffffff1f;
          background:linear-gradient(180deg, #ffffff14, #ffffff08); color:var(--txt); cursor:pointer; font-weight:700;
          transition: transform .12s ease, box-shadow .12s ease, background .2s; text-decoration:none; }
    .btn:hover{ transform: translateY(-1px); box-shadow:0 10px 16px #00000033 } .btn.primary{ background:linear-gradient(180deg, #75e6ff40, #7c6bff30); border-color:#9acbff44 }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px } @media (max-width: 800px){ .grid{ grid-template-columns:1fr } }
    .list{ display:grid; gap:10px; margin-top:8px; } .item{ display:flex; align-items:center; gap:10px; padding:12px; border:1px solid #ffffff17; border-radius:14px; background:var(--glass-strong) }
    .item a{ color:#dfe8ff; text-decoration:none; font-weight:600 } .item small{ color:var(--muted) }
    .section-title{ margin:22px 0 10px; font-size:.95rem; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:.12em }
    .quiz-setup, .quiz-play, .recap{ display:none } .visible{ display:block }
    label{ font-size:.9rem; color:#c8d3f3 } select, input[type="number"], input[type="text"]{ width:100%; padding:12px 12px; border-radius:12px; border:1px solid #ffffff24; background:#0f1731; color:var(--txt); }
    .field{ display:grid; gap:6px }
    .choices{ display:grid; gap:10px; margin-top:14px }
    .choice{ display:flex; align-items:center; gap:10px; padding:14px; border:1px solid #ffffff1f; border-radius:12px; cursor:pointer;
             background:linear-gradient(180deg, #ffffff10, #ffffff06); transition: transform .08s ease, border-color .08s ease, background .2s; }
    .choice:hover{ transform: translateY(-1px); border-color:#ffffff44 }
    .choice.correct{ border-color: #19d18b; background: linear-gradient(180deg, #19d18b22, #19d18b10) }
    .choice.wrong{ border-color: #ef4444; background: linear-gradient(180deg, #ef444422, #ef444410) }
    .progress{ height:10px; border-radius:999px; background:#0c1630; border:1px solid #ffffff11; overflow:hidden }
    .bar{ height:100%; width:0%; background:linear-gradient(90deg, var(--ac3), var(--ac2)); transition:width .25s ease }
    .meta{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; color:var(--muted) } .tag{ padding:6px 10px; border-radius:999px; background:#ffffff10; border:1px solid #ffffff1a; font-size:.8rem; }
    footer{ color:#93a0c7; text-align:center; font-size:.85rem; padding:40px 12px } footer a{ color:#cfe3ff }
    .particles{ position: fixed; inset: 0; pointer-events:none; z-index:-1 } .particle{ position:absolute; width:8px; height:8px; border-radius:999px; background:radial-gradient(#fff, transparent); opacity:.18; animation: float 18s ease-in-out infinite }
    @keyframes float{ 0%{ transform:translateY(0) } 50%{ transform:translateY(-40px) } 100%{ transform:translateY(0) } }
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.85em; background:#0c1630; border:1px solid #ffffff1a; padding:.05rem .4rem; border-radius:6px}

    /* --- Mobile/Tablet tweaks --- */
    @media (max-width: 768px){
      header{ padding: .7rem .8rem }
      .title{ font-size:1rem }
      .hero{ grid-template-columns:1fr }
      .btn{ width:100%; justify-content:center; padding:16px 18px; font-size:1rem }
      .card{ border-radius:16px }
      .choices .choice{ padding:16px; }
      .meta .tag{ margin-top:6px }
    }
    @media (pointer:coarse){
      .btn, .choice{ min-height:52px }
    }
    :root{ --vh: 1vh; }
    @supports (height: 1dvh){ :root{ --vh: 1dvh; } }
    .fullvh{ min-height: calc(var(--vh) * 100); }
  </style>
<link rel="icon" href="img/icon-192.png" sizes="192x192">
<link rel="apple-touch-icon" href="img/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
</head>
<body>
<noscript>Attiva JavaScript per eseguire i quiz.</noscript>
  <div class="aurora"></div><div class="particles" id="particles"></div>
  <header><div class="logo"><picture>
  <source type="image/webp" srcset="img/hero.webp">
  <picture class="site-logo">
  <img src="img/logo-antares.webp" alt="Logo Antares II" width="64" height="64" loading="eager" decoding="async" style="border-radius:50%;object-fit:cover;">
</picture>
</picture></div><div class="title">27¬∞ Corso Sergenti Antares II</div><div class="spacer"></div><div class="pill"></div></header>
  <main>
    <section class="hero">
      <div class="card">
        <h2>Benvenuto üëã</h2>
        <p style="color:var(--muted);margin:6px 0 10px">Un posto unico per i tuoi <strong>riassunti</strong> e per allenarti con il <strong>simulatore di quiz</strong>.</p>
        <div class="btn-row">
          <button class="btn primary" id="open-summary">üìö Riassunti PDF</button>
          <button class="btn" id="open-quiz">üß† Simulatore Quiz</button>
        </div>
      </div>
    </section>

    <section class="card" id="summary-section" style="margin-top:18px; display:none">
      <h2>üìö Riassunti (PDF)</h2>
      <div class="meta" style="margin-bottom:8px">
        <span class="tag">Cartella: /docs</span>
        <span class="tag" id="docs-count">0 file</span>
        <span class="tag">Suggerimento: premi <span class="kbd">L</span> per ricaricare</span>
      </div>
      <div class="list" id="docs-list"></div>
    </section>

    <section class="card quiz-setup" id="quiz-setup" style="margin-top:18px">
      <h2>üß† Simulatore di Quiz</h2>
      <div class="grid">
        <div class="field">
          <label for="subject">Materia</label>
          <div class="select-wrap"><select id="subject" class="select fancy"></select></div>
        </div>
        <div class="field">
          <label for="qcount">Numero di domande</label>
          <div class="select-wrap"><select id="qcount" class="select fancy"><option value="10">10</option><option value="20" selected>20</option><option value="30">30</option><option value="50">50</option><option value="100">100</option><option value="all">Tutte</option></select></div>
        </div>
      </div>
      <div class="btn-row" style="margin-top:14px">
        <button class="btn primary" id="start-quiz">‚ñ∂Ô∏è Avvia quiz</button>
        <button class="btn" id="shuffle-toggle">üîÄ Random ON</button>
        
        <input type="file" id="file-input" accept="application/json" style="display:none" />
      </div>
      <p class="section-title">Progressi</p>
      <div class="meta"><span class="tag" id="bank-size">‚Äì</span><span class="tag" id="saved-state">LocalStorage attivo</span></div>
    </section>

    <section class="card quiz-play" id="quiz-play" style="margin-top:18px">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
        <h2 id="quiz-title">Quiz</h2>
        <div class="meta"><span class="tag" id="tracker">0/0</span><span class="tag" id="score">Punteggio: 0</span></div>
      </div>
      <div class="progress" style="margin:10px 0 12px"><div class="bar" id="bar"></div></div>
      <div id="question" style="font-size:1.05rem; font-weight:600; line-height:1.5"></div>
      <div class="choices" id="choices"></div>
      <div class="btn-row" style="margin-top:16px">
        <button class="btn" id="prev">‚¨ÖÔ∏è Indietro</button>
        <button class="btn" id="next">Avanti ‚û°Ô∏è</button>
        <button class="btn" id="finish">üèÅ Termina</button>
        <button class="btn" id="restart">üîÅ Ricomincia</button>
      </div>
      <p class="section-title">Esito</p>
      <div class="meta"><span class="tag" id="result">‚Äì</span></div>
    </section>

    <section class="card recap" id="recap" style="margin-top:18px">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
        <h2>üìä Riepilogo quiz</h2>
        <div class="meta"><span class="tag" id="recap-score">‚Äì</span><span class="tag" id="recap-errors">‚Äì</span></div>
      </div>
      <div class="btn-row" style="margin-top:10px">
        <button class="btn primary" id="repeat-all">üîÅ Ripeti tutto</button>
        <button class="btn" id="repeat-errors">‚ôªÔ∏è Solo errori</button>
        <button class="btn" id="back-setup">‚¨ÖÔ∏è Torna alla scelta materia</button>
      </div>
      <div class="recap-list" id="recap-list"></div>
    </section>
<div class="notice">
<footer>
  <strong>Aggiornamenti giornalieri.</strong>
  Materiali caricati progressivamente in base ai nostri appunti.
  Le <strong>domande sono NON UFFICIALI generate con AI</strong> e hanno scopo didattico.
  
</footer>
</div>
    <footer> </footer>
  </main>

<div id="end-modal" class="modal-overlay hidden">
  <div class="modal card">
    <div class="modal-header">Termina quiz?</div>
    <div class="modal-body">Vuoi terminare il quiz?</div>
    <div class="modal-actions">
      <button class="btn" id="end-cancel">Annulla</button>
      <button class="btn primary" id="end-confirm">Termina</button>
    </div>
  </div>
</div>


  <script>
    (function spawnParticles(){
      const wrap = document.getElementById('particles');
      if(!wrap) return;
      const N = 40; const W = window.innerWidth; const H = window.innerHeight;
      for(let i=0;i<N;i++){
        const p = document.createElement('div'); p.className='particle';
        p.style.left = Math.random()*W + 'px';
        p.style.top  = Math.random()*H + 'px';
        p.style.animationDelay = (Math.random()*10).toFixed(2)+'s';
        p.style.animationDuration = (14 + Math.random()*10).toFixed(2)+'s';
        p.style.opacity = (0.10 + Math.random()*0.15).toFixed(2);
        wrap.appendChild(p);
      }
    })();

    const AudioFX = (function(){
      let ctx; function ensure(){ if(!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)(); }
      function play(freq, time, type, gain){
        ensure(); const o=ctx.createOscillator(), g=ctx.createGain();
        o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(ctx.destination);
        o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + time); o.stop(ctx.currentTime + time);
      }
      return { ok(){play(900,.12,'triangle',.08)}, ko(){play(220,.18,'sawtooth',.06)}, click(){play(600,.05,'sine',.04)} };
    })();

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const save = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
    const load = (k,d=null)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } };

    const summarySection = $('#summary-section');
    const quizSetup = $('#quiz-setup');
    const quizPlay = $('#quiz-play');
    const recap = $('#recap');

    $('#open-summary')?.addEventListener('click', ()=>{ showSummaries(); AudioFX.click(); });
    $('#open-quiz')?.addEventListener('click', ()=>{ quizSetup.classList.add('visible'); summarySection.style.display='none'; recap.classList.remove('visible'); AudioFX.click(); });

    async function fetchJSON(path){
      const bust = Date.now();
      try{
        const res = await fetch(`${path}?v=${bust}`, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        return await res.json();
      }catch(e){ return null }
    }

    async function showSummaries(){
      summarySection.style.display='block'; quizSetup.classList.remove('visible'); quizPlay.classList.remove('visible'); recap.classList.remove('visible');
      const index = await fetchJSON('docs/index.json') || {docs:[]};
      const list = $('#docs-list'); list.innerHTML='';
      const docs = index.docs || [];
      $('#docs-count').textContent = `${docs.length} file`;
      if(!docs.length){ list.innerHTML = `<div class="item"><small>Nessun file elencato. Crea <span class="kbd">/docs/index.json</span>.</small></div>`; return; }
      for(const d of docs){
        const v = (index && index.version) ? index.version : Date.now();
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `üìÑ <a target="_blank" href="docs/${encodeURIComponent(d.file)}?v=${v}">${d.title||d.file}</a> <small>(${d.file})</small>`;
        list.appendChild(row);
      }
    }

    const subjectSelect = $('#subject');
    const qcountInput = $('#qcount');
    const savedQ = load('qcount', '20'); if(qcountInput && savedQ) qcountInput.value = savedQ;
    const bankSizeTag = $('#bank-size');
    const shuffleBtn = $('#shuffle-toggle');
    const importBtn = $('#import-json');
    const fileInput = $('#file-input');
    let SHUFFLE = load('shuffle', true);
    function updateShuffleBtn(){ shuffleBtn.textContent = SHUFFLE ? 'üîÄ Random ON' : '‚è© Ordine fisso'; shuffleBtn.classList.toggle('primary', SHUFFLE); }
    updateShuffleBtn();
    shuffleBtn?.addEventListener('click', ()=>{ SHUFFLE = !SHUFFLE; save('shuffle', SHUFFLE); updateShuffleBtn(); AudioFX.click(); });
    importBtn?.addEventListener('click', ()=> fileInput.click());
    fileInput?.addEventListener('change', (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const reader = new FileReader(); reader.onload = ()=>{
        try{ const data = JSON.parse(reader.result); const customName = file.name.replace(/\.json$/i,''); customBanks[customName] = data; populateSubjects(); AudioFX.ok(); }
        catch{ alert('JSON non valido'); AudioFX.ko(); }
      }; reader.readAsText(file);
    });
    importBtn?.addEventListener('dragover', e=>{ e.preventDefault(); importBtn.style.borderColor = '#9acbffaa'; });
    importBtn?.addEventListener('dragleave', e=>{ importBtn.style.borderColor = ''; });
    importBtn?.addEventListener('drop', e=>{ e.preventDefault(); importBtn.style.borderColor = ''; const file = e.dataTransfer.files?.[0]; if(file){ fileInput.files = e.dataTransfer.files; fileInput.dispatchEvent(new Event('change')); } });

    let banksIndex = {subjects:[]};
    let customBanks = {};

    async function loadBanksIndex(){ const idx = await fetchJSON('data/index.json'); if(idx && Array.isArray(idx.subjects)) banksIndex = idx; populateSubjects(); }
    async function populateSubjects(){
      const prev = load('subject');
      subjectSelect.innerHTML = '';
      const subjects = [...(banksIndex.subjects||[]) , ...Object.keys(customBanks).map(k=>({name:`(locale) ${k}`, file:`__local__:${k}`}))];
      for(const s of subjects){ const opt = document.createElement('option'); opt.value=s.file; opt.textContent=s.name; subjectSelect.appendChild(opt); }
      if(prev){ subjectSelect.value = prev; }
      await previewBankSize();
    }
    subjectSelect?.addEventListener('change', ()=>{ save('subject', subjectSelect.value); previewBankSize(); AudioFX.click(); })
    qcountInput?.addEventListener('change', ()=> save('qcount', qcountInput.value));

    async function previewBankSize(){
      const file = subjectSelect.value; let data = [];
      if(file?.startsWith('__local__:')){ data = customBanks[file.split(':')[1]] || []; }
      else if(file){ const bank = await fetchJSON('data/' + file); if(bank) data = bank; }
      bankSizeTag.textContent = data.length ? `${data.length} domande in banca dati` : '0 domande';
    }

    const quizTitle = $('#quiz-title'); const qNode = $('#question'); const choicesNode = $('#choices');
    const bar = $('#bar'); const tracker = $('#tracker'); const scoreTag = $('#score'); const resultTag = $('#result');
    let questions = []; let order = []; let current = 0; let score = 0;
    const selected = new Map();  // idx -> chosen answer index
    const viewOrder = new Map(); // idx -> [display order of answers]
    const locked = new Set();    // idx answered
    let navBusy = false;
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr }
    function getSubjectLabel(){ const opt = subjectSelect.options[subjectSelect.selectedIndex]; return opt?.textContent || 'Materia'; }

    $('#start-quiz')?.addEventListener('click', async ()=>{
      const sel = subjectSelect.value; if(!sel){ alert('Seleziona una materia'); return }
      let bank = [];
      if(sel.startsWith('__local__:')){ bank = customBanks[sel.split(':')[1]] || []; } else { bank = await fetchJSON('data/' + sel) || []; }
      if(!Array.isArray(bank) || !bank.length) { alert('Banca dati vuota o non valida'); AudioFX.ko(); return }
      const n = (qcountInput.value==='all') ? bank.length : Math.min(parseInt(qcountInput.value||'1',10), bank.length);
      let pool = [...bank.keys()]; if(SHUFFLE) pool = shuffle(pool);
      order = pool.slice(0, n);
      questions = bank; current = 0; score = 0; selected.clear(); viewOrder.clear(); locked.clear();
      quizTitle.textContent = `Quiz ‚Äì ${getSubjectLabel()} (${n} domande)`;
      quizSetup.classList.remove('visible'); recap?.classList.remove('visible'); quizPlay.classList.add('visible');
      renderQuestion(); AudioFX.ok();
    });

    function getViewOrder(idx, answersLen){
      if(viewOrder.has(idx)) return viewOrder.get(idx);
      const base = Array.from({length: answersLen}, (_,i)=>i);
      const arr = SHUFFLE ? shuffle(base) : base;
      viewOrder.set(idx, arr);
      return arr;
    }

    function renderQuestion(){
      const idx = order[current]; const item = questions[idx]; if(!item){ return }
      tracker.textContent = `${current+1}/${order.length}`; scoreTag.textContent = `Punteggio: ${score}`; bar.style.width = ((current)/order.length*100).toFixed(1)+'%';
      qNode.textContent = item.question;
      const ansLen = Array.isArray(item.answers) ? item.answers.length : 0;
      const ord = getViewOrder(idx, ansLen);
      choicesNode.innerHTML = '';
      ord.forEach((k,i)=>{
        const div = document.createElement('div'); div.className='choice'; div.dataset.index = k;
        const letter = String.fromCharCode(65+i);
        div.innerHTML = `<div style="font-weight:700">${letter}</div><div>${item.answers?.[k] ?? '‚Äî'}</div>`;
        div.addEventListener('click', ()=> selectAnswer(idx, k));
        choicesNode.appendChild(div);
      });
      if(locked.has(idx)){
        paintChoices(idx, selected.get(idx), item.correctIndex);
        const ordPosCorrect = ord.indexOf(item.correctIndex);
        resultTag.textContent = (selected.get(idx)===item.correctIndex) ? '‚úÖ Corretto' : `‚ùå Errato ‚Äì Giusta: ${String.fromCharCode(65+ordPosCorrect)}`;
      }else{
        resultTag.textContent = '‚Äì';
      }
    }

    function paintChoices(idx, chosenK, correctK){
      $$('.choice').forEach(ch=>{
        const ii = parseInt(ch.dataset.index,10);
        ch.classList.toggle('correct', ii===correctK);
        ch.classList.toggle('wrong', ii===chosenK && chosenK!==correctK);
      });
    }

    function selectAnswer(idx, k){
      if(locked.has(idx)) return;
      const item = questions[idx]; if(!item) return;
      selected.set(idx, k); locked.add(idx);
      if(k === item.correctIndex){ score++; AudioFX.ok(); } else { AudioFX.ko(); }
      paintChoices(idx, k, item.correctIndex);
      scoreTag.textContent = `Punteggio: ${score}`;
      const ord = viewOrder.get(idx) || [0,1,2,3];
      const ordPosCorrect = ord.indexOf(item.correctIndex);
      resultTag.textContent = k===item.correctIndex ? '‚úÖ Corretto' : `‚ùå Errato ‚Äì Giusta: ${String.fromCharCode(65+ordPosCorrect)}`;
    }

    function safeNav(delta){
      if(navBusy) return; navBusy = true;
      const nextIdx = current + delta;
      if(nextIdx >= 0 && nextIdx < order.length){ current = nextIdx; renderQuestion(); AudioFX.click(); }
      setTimeout(()=> navBusy=false, 80);
    }
    $('#next')?.addEventListener('click', ()=>{
      try{
        if(typeof current!=='undefined' && Array.isArray(order) && current >= order.length - 1){
          openEndModal(); return;
        }
      }catch(_){}
      safeNav(+1);
    });
    $('#prev')?.addEventListener('click', ()=> safeNav(-1));

    $('#finish')?.addEventListener('click', ()=>{ openEndModal(); AudioFX.click(); });
    $('#restart')?.addEventListener('click', ()=>{
      const n = order.length;
      score=0; selected.clear(); locked.clear(); viewOrder.clear(); current=0;
      quizTitle.textContent = `Quiz ‚Äì ${getSubjectLabel()} (${n} domande)`; renderQuestion(); resultTag.textContent='‚Äì'; AudioFX.click();
    });

    function finishQuiz(){
      bar.style.width='100%';
      const total = order.length; const perc = Math.round(score / total * 100);
      resultTag.textContent = `üèÅ Completato: ${score}/${total} (${perc}%)`;
      showRecap();
    }

    function showRecap(){
      quizPlay.classList.remove('visible'); recap.classList.add('visible');
      const total = order.length;
      const err = order.filter(i => selected.get(i) !== questions[i].correctIndex);
      $('#recap-score').textContent = `Punteggio: ${score}/${total}`;
      $('#recap-errors').textContent = `Errori: ${err.length}`;
      const list = $('#recap-list'); list.innerHTML='';
      for(const idx of order){
        const q = questions[idx];
        const userK = selected.get(idx);
        const correctK = q.correctIndex;
        const ord = viewOrder.get(idx) || [0,1,2,3];
        const ok = (userK===correctK);
        const tua = userK!=null ? String.fromCharCode(65+ord.indexOf(userK)) : '‚Äî';
        const giusta = String.fromCharCode(65+ord.indexOf(correctK));
        const listHtml = ord.map((k,i)=>`${String.fromCharCode(65+i)}) ${q.answers[k]}`).join('<br/>');
        const item = document.createElement('div'); item.className='recap-item';
        item.innerHTML = `<h4>${q.question}</h4>
          <div class="meta"><span class="badge ${ok?'ok':'ko'}">${ok?'‚úîÔ∏è Corretto':'‚ùå Errato'}</span>
          <span class="tag">Tua: ${tua}</span>
          <span class="tag">Giusta: ${giusta}</span></div>
          <div style="margin-top:8px">${listHtml}</div>`;
        list.appendChild(item);
      }
      $('#repeat-all').onclick = ()=>{ startRepeat(order.slice()); };
      $('#repeat-errors').onclick = ()=>{ const errOrder = order.filter(i => selected.get(i) !== questions[i].correctIndex); if(!errOrder.length){ alert('Nessun errore da ripetere!'); return; } startRepeat(errOrder); };
      $('#back-setup').onclick = ()=>{ recap.classList.remove('visible'); quizSetup.classList.add('visible'); };
    }

    function startRepeat(newOrder){
      order = newOrder; current = 0; score = 0; selected.clear(); locked.clear(); viewOrder.clear();
      recap.classList.remove('visible'); quizPlay.classList.add('visible');
      quizTitle.textContent = `Quiz ‚Äì Ripetizione (${order.length} domande)`;
      renderQuestion();
    }

    document.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowRight') $('#next')?.click();
      if(e.key==='ArrowLeft') $('#prev')?.click();
      if(e.key.toLowerCase()==='l') showSummaries();
    });

    (async function init(){
      await loadBanksIndex();
      await showSummaries();
      save('subject', subjectSelect.value);
      await previewBankSize();
    })();
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
      });
    }
  </script>

  <!-- PATCH'S CORSO: floating animated download button -->
  <button id="patch-corso-btn" class="patch-corso-btn" type="button" aria-label="Scarica/Apri la patch del corso">
    <span class="patch-corso-glow" aria-hidden="true"></span>
    <span class="patch-corso-shine" aria-hidden="true"></span>
    <span class="patch-corso-text">PATCH CORSO</span>
  </button>

  <style>
    /* === PATCH CORSO (namespaced) === */
    #patch-corso-btn.patch-corso-btn {
      position: fixed;
      right: clamp(12px, 2vw, 22px);
      bottom: clamp(12px, 2vw, 22px);
      z-index: 9999;
      padding: 14px 22px;
      border: 0;
      border-radius: 999px;
      font: 800 14px/1.1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      letter-spacing: .6px;
      color: #081012;
      background: linear-gradient(135deg,#b2f7a6 0%,#79ffd2 35%,#5dd8ff 70%,#b0a3ff 100%);
      box-shadow: 0 12px 28px rgba(0,0,0,.25);
      cursor: pointer;
      transform: translateZ(0);
      will-change: transform, box-shadow;
      transition: transform .2s ease, box-shadow .2s ease, filter .2s ease;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    #patch-corso-btn .patch-corso-text { position: relative; z-index: 2; }
    #patch-corso-btn .patch-corso-glow {
      content: "";
      position: absolute; inset: -2px;
      z-index: 0;
      background: radial-gradient(120px 120px at var(--mx,50%) var(--my,50%), rgba(255,255,255,.35), transparent 55%);
      opacity: .0;
      transition: opacity .25s ease;
      pointer-events: none;
    }
    #patch-corso-btn .patch-corso-shine {
      content: "";
      position: absolute; inset: 0;
      background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,.35) 35%, transparent 70%);
      transform: translateX(-120%);
      animation: patch-corso-shine 3.2s infinite;
      mix-blend-mode: soft-light;
      pointer-events: none;
    }
    @keyframes patch-corso-shine {
      0% { transform: translateX(-120%); }
      60% { transform: translateX(120%); }
      100% { transform: translateX(120%); }
    }
    #patch-corso-btn:focus-visible {
      outline: 3px solid #79ffd2;
      outline-offset: 3px;
      filter: saturate(1.15);
    }
    #patch-corso-btn:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 16px 34px rgba(0,0,0,.28);
    }
    #patch-corso-btn:active {
      transform: translateY(0) scale(.98);
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
    }
    @keyframes patch-corso-pulse {
      0% { box-shadow: 0 0 0 0 rgba(0,255,200,.45); }
      70% { box-shadow: 0 0 0 16px rgba(0,255,200,0); }
      100% { box-shadow: 0 0 0 0 rgba(0,255,200,0); }
    }
    #patch-corso-btn { animation: patch-corso-pulse 2.6s ease-out infinite; }
    @media (max-width: 480px) {
      #patch-corso-btn.patch-corso-btn { padding: 12px 18px; font-size: 13px; }
    }
  </style>

  <script>
    // === PATCH CORSO: download/open handler ===
    (function() {
      // Percorso relativo rispetto al file HTML
      const FILE_NAME = "Patch.jpg";
      const FILE_PATH = FILE_NAME;
      const btn = document.getElementById("patch-corso-btn");
      if (!btn) return;

      btn.addEventListener("pointermove", e => {
        const r = e.currentTarget.getBoundingClientRect();
        const x = ((e.clientX - r.left) / r.width) * 100;
        const y = ((e.clientY - r.top) / r.height) * 100;
        btn.style.setProperty("--mx", x + "%");
        btn.style.setProperty("--my", y + "%");
        const glow = btn.querySelector(".patch-corso-glow");
        if (glow) glow.style.opacity = .9;
      });
      btn.addEventListener("pointerleave", () => {
        const glow = btn.querySelector(".patch-corso-glow");
        if (glow) glow.style.opacity = .0;
      });

      btn.addEventListener("click", async () => {
        try {
          const res = await fetch(FILE_PATH);
          if (!res.ok) throw new Error("HTTP " + res.status);
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = FILE_NAME;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 3000);
        } catch (err) {
          window.open(FILE_PATH, "_blank");
        }
      }, { passive: true });
    })();
  </script>

<script>
(function(){
  const overlay = document.getElementById('end-modal');
  const btnOk = document.getElementById('end-confirm');
  const btnNo = document.getElementById('end-cancel');
  function openEndModal(){ overlay?.classList.remove('hidden'); }
  function closeEndModal(){ overlay?.classList.add('hidden'); }
  window.openEndModal = openEndModal;
  btnNo?.addEventListener('click', closeEndModal);
  overlay?.addEventListener('click', (e)=>{ if(e.target===overlay) closeEndModal(); });
  btnOk?.addEventListener('click', ()=>{ closeEndModal(); finishQuiz(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeEndModal(); });
})();
</script>

</body>
</html>
